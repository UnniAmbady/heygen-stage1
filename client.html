<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>HeyGen Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <style>
      html,body { height:100%; margin:0; background:#000; }
      #wrap { position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr; }
      #status { color:#bbb; font:14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding:8px 10px; background:#111; }
      video { width:100%; height:100%; object-fit:contain; background:#000; }
      #tap { position:absolute; inset:auto 12px 12px auto; color:#111; background:#fff; padding:6px 10px; border-radius:999px; font:12px system-ui; display:none; }
    </style>
  </head>
  <body>
    <div id="wrap">
      <div id="status">Connecting…</div>
      <video id="v" autoplay playsinline muted></video>
      <div id="tap">tap to unmute</div>
    </div>

    <script type="module">
      import * as SDK from "https://cdn.jsdelivr.net/npm/@heygen/streaming-avatar/+esm";
      const { StreamingAvatar, StreamingEvents } = SDK;

      const TOKEN    = "__TOKEN__";
      const AVATARID = "__AVATAR_ID__";
      const VOICEID  = "__VOICE_ID__";

      const v = document.getElementById('v');
      const status = document.getElementById('status');
      const tap = document.getElementById('tap');

      const avatar = new StreamingAvatar({ token: TOKEN });
      if (avatar.setVideoElement) { try { avatar.setVideoElement(v); } catch(e){} }

      const show = (t) => status.textContent = t;

      avatar.on(StreamingEvents.STREAM_READY, (evt) => {
        if (evt?.detail) v.srcObject = evt.detail;
        show("Live");
        tap.style.display = "inline-block";
      });
      avatar.on(StreamingEvents.ERROR, (evt) => {
        const err = evt?.detail || evt;
        show("Error — see console");
        console.error("SDK error:", err);
      });
      avatar.on(StreamingEvents.STREAM_DISCONNECTED, () => show("Disconnected"));

      // Start the avatar stream with given avatar & voice
      (async () => {
        try {
          const opts = { avatarId: AVATARID, quality: "low", voice: { voice_id: VOICEID } };
          await avatar.createStartAvatar(opts);
        } catch (e) {
          show("Start failed");
          console.error(e);
        }
      })();

      // Unmute on first tap (mobile-friendly)
      const tryUnmute = async () => { try { v.muted = false; await v.play(); tap.style.display = "none"; } catch(e){} };
      tap.addEventListener('click', tryUnmute);
      v.addEventListener('click', tryUnmute);
      document.body.addEventListener('touchstart', tryUnmute, { once:true });
    </script>
  </body>
</html>
